# ---------------------------------------------------------------------------
# Multi-Phasic Applications: SquirrelJME
#     Copyright (C) Stephanie Gawroriski <xer@multiphasicapps.net>
#     Copyright (C) Multi-Phasic Applications <multiphasicapps.net>
# ---------------------------------------------------------------------------
# SquirrelJME is under the GNU General Public License v3, or later.
# See license.mkd for licensing and copyright information.
# ---------------------------------------------------------------------------
# DESCRIPTION: CircleCI Build Configuration

version: 2.1
executors:
  buildenv:
    docker:
      - image: circleci/openjdk:8-jdk
    working_directory: ~/squirreljme-build

commands:
  initialize_buildenv:
    description: "Initializes the build environment"
    steps:
      - checkout:
          path: ~/squirreljme
      - run:
          name: Setup directory
          command: mkdir -p ~/squirreljme-build

jobs:
  build_javase:
    executor: buildenv
    steps:
      - initialize_buildenv
      - run:
          name: Shade JavaSE
          command: ~/squirreljme/build.sh dist javase
  build_javame:
    executor: buildenv
    steps:
      - initialize_buildenv
      - run:
          name: Shade JavaME
          command: ~/squirreljme/build.sh dist javame
  tests_stablevm:
    executor: buildenv
    steps:
      - initialize_buildenv
      - run:
          name: Create test directory
          command: mkdir -p jut/stablevm
      - run:
          name: Running Stable VM
          command: ~/squirreljme/build.sh launch tac-runner > jut/stablevm/results.xml
      - store_test_results:
          path: jut
  tests_unstablevm:
    executor: buildenv
    steps:
      - initialize_buildenv
      - run:
          name: Create test directory
          command: mkdir -p jut/unstablevm
      - run:
          name: Running Unstable VM
          command: ~/squirreljme/build.sh launch -v summercoat tac-runner > jut/unstablevm/results.xml
      - store_test_results:
          path: jut

workflows:
  version: 2
  build:
    jobs:
      - build_javase
      - build_javame
  tests:
    jobs:
      - tests_stablevm
      - tests_unstablevm

